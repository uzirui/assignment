import{_ as oe,p as ne,j as G,k as ae,r as y,o as le,c,m as C,b as s,e as r,w as n,a as e,t as u,F as M,g as B,d as ie,h as i,u as I,i as h,f as N,q as re}from"./index-CIru5doz.js";import{u as ce}from"./article-V0l2JBZU.js";import{m as K,H as R}from"./atom-one-light-CPo-NblP.js";const ue={class:"article-detail-page"},de={key:0,class:"loading-container"},_e={key:1,class:"error-container"},me={key:2,class:"article-container"},ve={class:"article-header"},pe={class:"article-title"},he={class:"article-meta"},fe={class:"author-info"},ye={class:"author-details"},ge={class:"author-name"},ke={class:"publish-date"},we={class:"article-tags"},Ce=["innerHTML"],Te={class:"article-actions"},Ae={class:"comments-section"},De={class:"section-title"},Se={class:"comment-form"},be={key:0,class:"reply-info"},xe={class:"form-actions"},ze={key:0,class:"comments-list"},Le={class:"comment-header"},Ve={class:"comment-author"},Fe={class:"author-info"},Me={class:"author-name"},Be={class:"comment-date"},Ie={class:"comment-actions"},Ne={class:"el-dropdown-link"},Re={class:"comment-content"},He={key:0,class:"replies-list"},$e={class:"reply-header"},qe={class:"reply-author"},Ue={class:"author-info"},je={class:"author-name"},Ee={class:"reply-date"},Je={class:"reply-actions"},Oe={class:"el-dropdown-link"},Pe={class:"reply-content"},Ge={key:1,class:"no-comments"},Ke={__name:"ArticleDetail",setup(Qe){const H=ae(),$=ie(),S=ce(),b=ne(),x=G(()=>H.params.id),a=y(null),z=y(!0),g=y(null),m=y(""),k=y(!1),d=y(null),L=G(()=>b.isLoggedIn);K.setOptions({highlight:function(o,t){return t&&R.getLanguage(t)?R.highlight(o,{language:t}).value:R.highlightAuto(o).value},breaks:!0}),le(async()=>{await Q()});const Q=async()=>{z.value=!0,g.value=null;try{const o=await S.fetchArticleById(x.value);o?a.value=o:g.value="文章不存在或已被删除"}catch(o){console.error("获取文章详情失败:",o),g.value="获取文章详情失败"}finally{z.value=!1}},W=o=>K.parse(o),X=async()=>{if(!m.value.trim()||k.value)return;if(!L.value){$.push({path:"/login",query:{redirect:H.fullPath}});return}k.value=!0;const o=m.value,t=d.value;try{const f={content:o};if(t&&(f.replyTo=t),a.value&&a.value.comments){const F=!t&&a.value.comments.some(v=>v.content===o&&new Date().getTime()-new Date(v.createdAt).getTime()<1e4),w=t&&a.value.comments.some(v=>v.id===t.id&&v.replies?v.replies.some(T=>T.content===o&&new Date().getTime()-new Date(T.createdAt).getTime()<1e4):!1);if(F||w){console.log("前端检测到重复评论，已阻止提交"),m.value="",d.value=null,k.value=!1;return}}await S.addComment(x.value,f)&&(m.value="",d.value=null)}catch(f){console.error("提交评论失败:",f)}finally{setTimeout(()=>{k.value=!1},800)}},Y=o=>{d.value=o,m.value="",re(()=>{document.querySelector(".comment-form textarea").focus()})},Z=()=>{d.value=null},q=async o=>{try{await S.deleteComment(x.value,o)}catch(t){console.error("删除评论失败:",t)}},V=o=>new Date(o).toLocaleString("zh-CN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return(o,t)=>{var O;const f=r("el-skeleton"),p=r("el-button"),F=r("el-result"),w=r("el-avatar"),v=r("el-tag"),T=r("StarFilled"),A=r("el-icon"),ee=r("Share"),te=r("el-input"),U=r("MoreFilled"),j=r("el-dropdown-item"),E=r("el-dropdown-menu"),J=r("el-dropdown"),se=r("el-empty");return i(),c("div",ue,[z.value?(i(),c("div",de,[s(f,{rows:15,animated:""})])):g.value?(i(),c("div",_e,[s(F,{icon:"error",title:g.value,"sub-title":"请稍后再试或返回首页"},{extra:n(()=>[s(p,{type:"primary",onClick:t[0]||(t[0]=l=>I($).push("/"))},{default:n(()=>t[2]||(t[2]=[h("返回首页")])),_:1})]),_:1},8,["title"])])):a.value?(i(),c("div",me,[e("div",ve,[e("h1",pe,u(a.value.title),1),e("div",he,[e("div",fe,[s(w,{size:40,src:a.value.author.avatar},null,8,["src"]),e("div",ye,[e("span",ge,u(a.value.author.username),1),e("span",ke,u(V(a.value.createdAt)),1)])]),t[3]||(t[3]=e("div",{class:"article-stats"},null,-1))]),e("div",we,[(i(!0),c(M,null,B(a.value.tags,(l,D)=>(i(),N(v,{key:D,size:"small",class:"tag-item"},{default:n(()=>[h(u(l),1)]),_:2},1024))),128))])]),e("div",{class:"article-content markdown-body",innerHTML:W(a.value.content)},null,8,Ce),e("div",Te,[s(p,{type:"primary",plain:"",circle:""},{default:n(()=>[s(A,null,{default:n(()=>[s(T)]),_:1})]),_:1}),s(p,{type:"success",plain:"",circle:""},{default:n(()=>[s(A,null,{default:n(()=>[s(ee)]),_:1})]),_:1})]),e("div",Ae,[e("h3",De,"评论 ("+u(((O=a.value.comments)==null?void 0:O.length)||0)+")",1),e("div",Se,[d.value?(i(),c("div",be,[e("span",null,"回复 "+u(d.value.author.username)+":",1),s(p,{type:"text",onClick:Z},{default:n(()=>t[4]||(t[4]=[h("取消")])),_:1})])):C("",!0),s(te,{modelValue:m.value,"onUpdate:modelValue":t[1]||(t[1]=l=>m.value=l),type:"textarea",rows:3,placeholder:d.value?"写下你的回复...":"写下你的评论...",resize:"none"},null,8,["modelValue","placeholder"]),e("div",xe,[s(p,{type:"primary",onClick:X,loading:k.value,disabled:!m.value.trim()},{default:n(()=>[h(u(d.value?"提交回复":"发表评论"),1)]),_:1},8,["loading","disabled"])])]),a.value.comments&&a.value.comments.length>0?(i(),c("div",ze,[(i(!0),c(M,null,B(a.value.comments,l=>{var D;return i(),c("div",{key:l.id,class:"comment-item"},[e("div",Le,[e("div",Ve,[s(w,{size:32,src:l.author.avatar},null,8,["src"]),e("div",Fe,[e("span",Me,u(l.author.username),1),e("span",Be,u(V(l.createdAt)),1)])]),e("div",Ie,[s(p,{type:"primary",link:"",size:"small",onClick:_=>Y(l)},{default:n(()=>t[5]||(t[5]=[h(" 回复 ")])),_:2},1032,["onClick"]),L.value&&((D=I(b).user)==null?void 0:D.id)===l.author.id?(i(),N(J,{key:0},{dropdown:n(()=>[s(E,null,{default:n(()=>[s(j,{onClick:_=>q(l.id)},{default:n(()=>t[6]||(t[6]=[h(" 删除 ")])),_:2},1032,["onClick"])]),_:2},1024)]),default:n(()=>[e("span",Ne,[s(A,null,{default:n(()=>[s(U)]),_:1})])]),_:2},1024)):C("",!0)])]),e("div",Re,u(l.content),1),l.replies&&l.replies.length>0?(i(),c("div",He,[(i(!0),c(M,null,B(l.replies,_=>{var P;return i(),c("div",{key:_.id,class:"reply-item"},[e("div",$e,[e("div",qe,[s(w,{size:24,src:_.author.avatar},null,8,["src"]),e("div",Ue,[e("span",je,u(_.author.username),1),e("span",Ee,u(V(_.createdAt)),1)])]),e("div",Je,[L.value&&((P=I(b).user)==null?void 0:P.id)===_.author.id?(i(),N(J,{key:0},{dropdown:n(()=>[s(E,null,{default:n(()=>[s(j,{onClick:We=>q(_.id)},{default:n(()=>t[7]||(t[7]=[h(" 删除 ")])),_:2},1032,["onClick"])]),_:2},1024)]),default:n(()=>[e("span",Oe,[s(A,null,{default:n(()=>[s(U)]),_:1})])]),_:2},1024)):C("",!0)])]),e("div",Pe,u(_.content),1)])}),128))])):C("",!0)])}),128))])):(i(),c("div",Ge,[s(se,{description:"暂无评论，快来发表第一条评论吧！"})]))])])):C("",!0)])}}},et=oe(Ke,[["__scopeId","data-v-a456e07f"]]);export{et as default};
