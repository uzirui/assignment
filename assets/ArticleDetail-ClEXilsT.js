import{_ as le,p as ie,j as P,k as ce,r as g,o as re,c as u,m as D,b as t,e as l,w as o,a as e,t as c,F as R,g as F,d as ue,h as r,u as M,i as f,f as B,q as de}from"./index-j3DZukop.js";import{u as _e}from"./article-CBd4WTgj.js";import{m as G,H as I}from"./atom-one-light-CvIWhgc7.js";const me={class:"article-detail-page"},ve={key:0,class:"loading-container"},pe={key:1,class:"error-container"},he={key:2,class:"article-container"},fe={class:"article-header"},ye={class:"article-title"},ge={class:"article-meta"},ke={class:"author-info"},we={class:"author-details"},Ce={class:"author-name"},De={class:"publish-date"},Se={class:"article-stats"},Te={class:"stat-item"},Ae={class:"stat-item"},be={class:"stat-item"},xe={class:"article-tags"},Ve=["innerHTML"],ze={class:"article-actions"},Le={class:"comments-section"},Re={class:"section-title"},Fe={class:"comment-form"},Me={key:0,class:"reply-info"},Be={class:"form-actions"},Ie={key:0,class:"comments-list"},Ne={class:"comment-header"},He={class:"comment-author"},$e={class:"author-info"},qe={class:"author-name"},Ue={class:"comment-date"},je={class:"comment-actions"},Ee={class:"el-dropdown-link"},Je={class:"comment-content"},Oe={key:0,class:"replies-list"},Pe={class:"reply-header"},Ge={class:"reply-author"},Ke={class:"author-info"},Qe={class:"author-name"},We={class:"reply-date"},Xe={class:"reply-actions"},Ye={class:"el-dropdown-link"},Ze={class:"reply-content"},et={key:1,class:"no-comments"},tt={__name:"ArticleDetail",setup(st){const N=ce(),H=ue(),T=_e(),A=ie(),b=P(()=>N.params.id),a=g(null),x=g(!0),k=g(null),v=g(""),w=g(!1),_=g(null),V=P(()=>A.isLoggedIn);G.setOptions({highlight:function(n,s){return s&&I.getLanguage(s)?I.highlight(n,{language:s}).value:I.highlightAuto(n).value},breaks:!0}),re(async()=>{await K()});const K=async()=>{x.value=!0,k.value=null;try{const n=await T.fetchArticleById(b.value);n?a.value=n:k.value="文章不存在或已被删除"}catch(n){console.error("获取文章详情失败:",n),k.value="获取文章详情失败"}finally{x.value=!1}},Q=n=>G.parse(n),W=async()=>{if(!v.value.trim()||w.value)return;if(!V.value){H.push({path:"/login",query:{redirect:N.fullPath}});return}w.value=!0;const n=v.value,s=_.value;try{const y={content:n};if(s&&(y.replyTo=s),a.value&&a.value.comments){const L=!s&&a.value.comments.some(p=>p.content===n&&new Date().getTime()-new Date(p.createdAt).getTime()<1e4),C=s&&a.value.comments.some(p=>p.id===s.id&&p.replies?p.replies.some(d=>d.content===n&&new Date().getTime()-new Date(d.createdAt).getTime()<1e4):!1);if(L||C){console.log("前端检测到重复评论，已阻止提交"),v.value="",_.value=null,w.value=!1;return}}await T.addComment(b.value,y)&&(v.value="",_.value=null)}catch(y){console.error("提交评论失败:",y)}finally{setTimeout(()=>{w.value=!1},800)}},X=n=>{_.value=n,v.value="",de(()=>{document.querySelector(".comment-form textarea").focus()})},Y=()=>{_.value=null},$=async n=>{try{await T.deleteComment(b.value,n)}catch(s){console.error("删除评论失败:",s)}},z=n=>new Date(n).toLocaleString("zh-CN",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return(n,s)=>{var J;const y=l("el-skeleton"),h=l("el-button"),L=l("el-result"),C=l("el-avatar"),p=l("View"),d=l("el-icon"),Z=l("ChatDotRound"),ee=l("Star"),te=l("el-tag"),se=l("StarFilled"),oe=l("Share"),ne=l("el-input"),q=l("MoreFilled"),U=l("el-dropdown-item"),j=l("el-dropdown-menu"),E=l("el-dropdown"),ae=l("el-empty");return r(),u("div",me,[x.value?(r(),u("div",ve,[t(y,{rows:15,animated:""})])):k.value?(r(),u("div",pe,[t(L,{icon:"error",title:k.value,"sub-title":"请稍后再试或返回首页"},{extra:o(()=>[t(h,{type:"primary",onClick:s[0]||(s[0]=i=>M(H).push("/"))},{default:o(()=>s[2]||(s[2]=[f("返回首页")])),_:1})]),_:1},8,["title"])])):a.value?(r(),u("div",he,[e("div",fe,[e("h1",ye,c(a.value.title),1),e("div",ge,[e("div",ke,[t(C,{size:40,src:a.value.author.avatar},null,8,["src"]),e("div",we,[e("span",Ce,c(a.value.author.username),1),e("span",De,c(z(a.value.createdAt)),1)])]),e("div",Se,[e("span",Te,[t(d,null,{default:o(()=>[t(p)]),_:1}),e("span",null,c(a.value.viewCount)+" 阅读",1)]),e("span",Ae,[t(d,null,{default:o(()=>[t(Z)]),_:1}),e("span",null,c(a.value.commentCount)+" 评论",1)]),e("span",be,[t(d,null,{default:o(()=>[t(ee)]),_:1}),e("span",null,c(a.value.likeCount)+" 点赞",1)])])]),e("div",xe,[(r(!0),u(R,null,F(a.value.tags,(i,S)=>(r(),B(te,{key:S,size:"small",class:"tag-item"},{default:o(()=>[f(c(i),1)]),_:2},1024))),128))])]),e("div",{class:"article-content markdown-body",innerHTML:Q(a.value.content)},null,8,Ve),e("div",ze,[t(h,{type:"primary",plain:"",circle:""},{default:o(()=>[t(d,null,{default:o(()=>[t(se)]),_:1})]),_:1}),t(h,{type:"success",plain:"",circle:""},{default:o(()=>[t(d,null,{default:o(()=>[t(oe)]),_:1})]),_:1})]),e("div",Le,[e("h3",Re,"评论 ("+c(((J=a.value.comments)==null?void 0:J.length)||0)+")",1),e("div",Fe,[_.value?(r(),u("div",Me,[e("span",null,"回复 "+c(_.value.author.username)+":",1),t(h,{type:"text",onClick:Y},{default:o(()=>s[3]||(s[3]=[f("取消")])),_:1})])):D("",!0),t(ne,{modelValue:v.value,"onUpdate:modelValue":s[1]||(s[1]=i=>v.value=i),type:"textarea",rows:3,placeholder:_.value?"写下你的回复...":"写下你的评论...",resize:"none"},null,8,["modelValue","placeholder"]),e("div",Be,[t(h,{type:"primary",onClick:W,loading:w.value,disabled:!v.value.trim()},{default:o(()=>[f(c(_.value?"提交回复":"发表评论"),1)]),_:1},8,["loading","disabled"])])]),a.value.comments&&a.value.comments.length>0?(r(),u("div",Ie,[(r(!0),u(R,null,F(a.value.comments,i=>{var S;return r(),u("div",{key:i.id,class:"comment-item"},[e("div",Ne,[e("div",He,[t(C,{size:32,src:i.author.avatar},null,8,["src"]),e("div",$e,[e("span",qe,c(i.author.username),1),e("span",Ue,c(z(i.createdAt)),1)])]),e("div",je,[t(h,{type:"primary",link:"",size:"small",onClick:m=>X(i)},{default:o(()=>s[4]||(s[4]=[f(" 回复 ")])),_:2},1032,["onClick"]),V.value&&((S=M(A).user)==null?void 0:S.id)===i.author.id?(r(),B(E,{key:0},{dropdown:o(()=>[t(j,null,{default:o(()=>[t(U,{onClick:m=>$(i.id)},{default:o(()=>s[5]||(s[5]=[f(" 删除 ")])),_:2},1032,["onClick"])]),_:2},1024)]),default:o(()=>[e("span",Ee,[t(d,null,{default:o(()=>[t(q)]),_:1})])]),_:2},1024)):D("",!0)])]),e("div",Je,c(i.content),1),i.replies&&i.replies.length>0?(r(),u("div",Oe,[(r(!0),u(R,null,F(i.replies,m=>{var O;return r(),u("div",{key:m.id,class:"reply-item"},[e("div",Pe,[e("div",Ge,[t(C,{size:24,src:m.author.avatar},null,8,["src"]),e("div",Ke,[e("span",Qe,c(m.author.username),1),e("span",We,c(z(m.createdAt)),1)])]),e("div",Xe,[V.value&&((O=M(A).user)==null?void 0:O.id)===m.author.id?(r(),B(E,{key:0},{dropdown:o(()=>[t(j,null,{default:o(()=>[t(U,{onClick:ot=>$(m.id)},{default:o(()=>s[6]||(s[6]=[f(" 删除 ")])),_:2},1032,["onClick"])]),_:2},1024)]),default:o(()=>[e("span",Ye,[t(d,null,{default:o(()=>[t(q)]),_:1})])]),_:2},1024)):D("",!0)])]),e("div",Ze,c(m.content),1)])}),128))])):D("",!0)])}),128))])):(r(),u("div",et,[t(ae,{description:"暂无评论，快来发表第一条评论吧！"})]))])])):D("",!0)])}}},it=le(tt,[["__scopeId","data-v-eda15f80"]]);export{it as default};
